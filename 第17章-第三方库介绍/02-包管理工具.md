# 02-包管理工具

## 🛠️ 包管理工具概览

### 什么是包管理工具？
包管理工具是用于安装、升级、卸载和管理Python包的软件工具。它们简化了依赖管理，确保项目的可重现性。

### 主要包管理工具
- **pip**：Python官方包管理工具
- **conda**：跨语言的包和环境管理器
- **poetry**：现代Python依赖管理工具
- **pipenv**：结合pip和virtualenv的工具
- **pip-tools**：pip的增强工具集

## 📦 pip - Python官方包管理器

### pip基础使用
```bash
# 安装包
pip install package_name

# 安装特定版本
pip install package_name==1.2.3

# 安装版本范围
pip install "package_name>=1.0,<2.0"

# 从requirements.txt安装
pip install -r requirements.txt

# 升级包
pip install --upgrade package_name

# 卸载包
pip uninstall package_name

# 列出已安装的包
pip list

# 显示包信息
pip show package_name

# 检查依赖关系
pip check
```

### pip高级功能
```bash
# 只下载不安装
pip download package_name

# 从本地文件安装
pip install ./my_package.tar.gz
pip install ./my_package/

# 从Git仓库安装
pip install git+https://github.com/user/repo.git

# 安装可编辑模式（开发模式）
pip install -e .

# 生成requirements.txt
pip freeze > requirements.txt

# 安装用户级包（不需要管理员权限）
pip install --user package_name

# 指定索引源
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple/ package_name
```

### requirements.txt详解
```txt
# requirements.txt 示例

# 精确版本
requests==2.28.1

# 版本范围
numpy>=1.21.0,<1.22.0

# 兼容版本
pandas~=1.3.0

# 最小版本
matplotlib>=3.5.0

# 开发依赖（通常单独文件）
# requirements-dev.txt
pytest>=6.0.0
black>=22.0.0
flake8>=4.0.0

# 从Git安装
git+https://github.com/user/repo.git@v1.0.0

# 本地包
-e ./local_package

# 包含其他requirements文件
-r requirements-base.txt
```

### pip配置
```ini
# pip.conf (Linux/Mac: ~/.pip/pip.conf, Windows: %APPDATA%\pip\pip.ini)
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple/
trusted-host = pypi.tuna.tsinghua.edu.cn
timeout = 60

[install]
user = true
```

## 🐍 conda - 跨语言包管理器

### conda基础概念
```python
# conda的优势
conda_advantages = {
    "跨语言支持": "不仅支持Python，还支持R、C++等",
    "二进制包": "预编译包，安装速度快",
    "环境管理": "内置虚拟环境管理",
    "科学计算": "专为科学计算优化",
    "依赖解决": "强大的依赖解决算法"
}
```

### conda基础命令
```bash
# 安装包
conda install package_name

# 从特定频道安装
conda install -c conda-forge package_name

# 安装多个包
conda install numpy pandas matplotlib

# 升级包
conda update package_name
conda update --all

# 卸载包
conda remove package_name

# 列出包
conda list

# 搜索包
conda search package_name

# 显示包信息
conda info package_name
```

### conda环境管理
```bash
# 创建环境
conda create -n myenv python=3.9

# 创建环境并安装包
conda create -n myenv python=3.9 numpy pandas

# 激活环境
conda activate myenv

# 停用环境
conda deactivate

# 列出环境
conda env list

# 删除环境
conda env remove -n myenv

# 导出环境
conda env export > environment.yml

# 从文件创建环境
conda env create -f environment.yml
```

### environment.yml文件
```yaml
# environment.yml 示例
name: myproject
channels:
  - conda-forge
  - defaults
dependencies:
  - python=3.9
  - numpy>=1.21
  - pandas>=1.3
  - matplotlib>=3.5
  - pip
  - pip:
    - requests>=2.25
    - click>=7.0
```

## 🎭 poetry - 现代依赖管理

### poetry的特点
- **依赖解析**：智能依赖解析和锁定
- **项目管理**：完整的项目生命周期管理
- **构建发布**：内置构建和发布功能
- **虚拟环境**：自动虚拟环境管理

### poetry基础使用
```bash
# 安装poetry
curl -sSL https://install.python-poetry.org | python3 -

# 创建新项目
poetry new my-project

# 初始化现有项目
poetry init

# 安装依赖
poetry install

# 添加依赖
poetry add requests
poetry add pytest --group dev

# 更新依赖
poetry update

# 删除依赖
poetry remove requests

# 显示依赖树
poetry show --tree

# 运行命令
poetry run python script.py

# 激活shell
poetry shell
```

### pyproject.toml配置
```toml
# pyproject.toml 示例
[tool.poetry]
name = "my-project"
version = "0.1.0"
description = "A sample Python project"
authors = ["Your Name <you@example.com>"]
readme = "README.md"
packages = [{include = "my_project"}]

[tool.poetry.dependencies]
python = "^3.8"
requests = "^2.25.0"
click = "^7.0"

[tool.poetry.group.dev.dependencies]
pytest = "^6.0"
black = "^22.0"
flake8 = "^4.0"

[tool.poetry.group.docs.dependencies]
sphinx = "^4.0"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"

[tool.poetry.scripts]
my-cli = "my_project.cli:main"
```

## 🔧 其他包管理工具

### pipenv
```bash
# 安装pipenv
pip install pipenv

# 创建虚拟环境并安装依赖
pipenv install

# 安装包
pipenv install requests

# 安装开发依赖
pipenv install pytest --dev

# 激活环境
pipenv shell

# 运行命令
pipenv run python script.py

# 生成requirements.txt
pipenv requirements > requirements.txt
```

### pip-tools
```bash
# 安装pip-tools
pip install pip-tools

# 从requirements.in生成requirements.txt
pip-compile requirements.in

# 同步环境
pip-sync requirements.txt

# 升级依赖
pip-compile --upgrade requirements.in
```

## 📊 工具对比

### 功能对比表
```python
tool_comparison = {
    "特性": {
        "pip": "基础包管理",
        "conda": "跨语言+环境管理",
        "poetry": "现代项目管理",
        "pipenv": "简化的pip+virtualenv"
    },
    "依赖解析": {
        "pip": "基础",
        "conda": "强大",
        "poetry": "智能",
        "pipenv": "中等"
    },
    "环境管理": {
        "pip": "需要virtualenv",
        "conda": "内置",
        "poetry": "自动",
        "pipenv": "内置"
    },
    "构建发布": {
        "pip": "需要其他工具",
        "conda": "支持",
        "poetry": "内置",
        "pipenv": "不支持"
    },
    "学习曲线": {
        "pip": "简单",
        "conda": "中等",
        "poetry": "中等",
        "pipenv": "简单"
    }
}
```

### 选择建议
```python
# 使用场景建议
use_cases = {
    "初学者": "pip + virtualenv",
    "数据科学": "conda",
    "现代Python项目": "poetry",
    "简单项目": "pipenv",
    "企业环境": "pip + pip-tools"
}
```

## 🔒 包安全

### 安全检查工具
```bash
# 使用safety检查已知漏洞
pip install safety
safety check

# 使用bandit检查代码安全
pip install bandit
bandit -r my_project/

# 使用pip-audit检查依赖漏洞
pip install pip-audit
pip-audit
```

### 安全最佳实践
```python
security_practices = {
    "依赖审计": "定期检查依赖的安全漏洞",
    "版本锁定": "使用精确版本或锁定文件",
    "来源验证": "只从可信源安装包",
    "最小权限": "避免使用sudo安装包",
    "定期更新": "及时更新有安全修复的包",
    "虚拟环境": "使用虚拟环境隔离项目"
}
```

## 🎯 本节小结

- **pip基础**：掌握Python官方包管理器的使用
- **conda优势**：了解科学计算领域的强大工具
- **poetry现代**：体验现代Python项目管理方式
- **工具选择**：根据项目需求选择合适的工具
- **安全意识**：重视包管理的安全性

## 💡 关键要点

1. **工具选择**：根据项目类型和团队需求选择合适的包管理工具
2. **版本管理**：合理使用版本约束，保持项目稳定性
3. **环境隔离**：始终使用虚拟环境进行开发
4. **依赖锁定**：使用锁定文件确保环境一致性
5. **安全检查**：定期检查依赖的安全漏洞

## 📚 延伸阅读
- [pip用户指南](https://pip.pypa.io/en/stable/user_guide/)
- [conda用户指南](https://docs.conda.io/projects/conda/en/latest/user-guide/)
- [poetry文档](https://python-poetry.org/docs/)
- [Python包安全指南](https://packaging.python.org/guides/analyzing-pypi-package-downloads/)
