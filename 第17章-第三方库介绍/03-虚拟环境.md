# 03-虚拟环境

## 🏠 什么是虚拟环境？

### 虚拟环境的概念
虚拟环境是Python的一个独立运行环境，它允许你为不同的项目创建隔离的Python环境，每个环境可以有自己的包和依赖版本。

### 为什么需要虚拟环境？
```python
# 问题场景
problems_without_venv = {
    "依赖冲突": {
        "项目A": "需要 Django 3.2",
        "项目B": "需要 Django 4.1",
        "系统环境": "只能安装一个版本"
    },
    "版本混乱": {
        "开发环境": "Python 3.9 + numpy 1.21",
        "生产环境": "Python 3.8 + numpy 1.20",
        "结果": "代码在不同环境表现不一致"
    },
    "权限问题": {
        "系统包": "需要管理员权限安装",
        "用户包": "可能影响其他用户",
        "风险": "意外破坏系统Python环境"
    }
}

# 虚拟环境的解决方案
venv_solutions = {
    "环境隔离": "每个项目独立的包环境",
    "版本管理": "精确控制每个项目的依赖版本",
    "权限控制": "用户级安装，无需管理员权限",
    "环境重现": "轻松在不同机器上重现环境",
    "清理简单": "删除目录即可清理环境"
}
```

## 🛠️ venv - Python内置虚拟环境

### venv基础使用
```bash
# 创建虚拟环境
python -m venv myenv

# 在指定目录创建
python -m venv /path/to/myenv

# 激活虚拟环境（Linux/Mac）
source myenv/bin/activate

# 激活虚拟环境（Windows）
myenv\Scripts\activate

# 停用虚拟环境
deactivate

# 删除虚拟环境
rm -rf myenv  # Linux/Mac
rmdir /s myenv  # Windows
```

### venv高级选项
```bash
# 创建时指定Python版本
python3.9 -m venv myenv

# 不复制pip（需要手动安装）
python -m venv --without-pip myenv

# 使用系统包（不推荐）
python -m venv --system-site-packages myenv

# 清除环境并重新创建
python -m venv --clear myenv

# 升级虚拟环境
python -m venv --upgrade myenv
```

### 虚拟环境的结构
```
myenv/
├── bin/                 # 可执行文件（Linux/Mac）
│   ├── activate         # 激活脚本
│   ├── python          # Python解释器链接
│   ├── pip             # pip工具
│   └── ...
├── Scripts/            # 可执行文件（Windows）
│   ├── activate.bat    # 激活脚本
│   ├── python.exe      # Python解释器
│   └── ...
├── lib/                # 库文件
│   └── python3.x/
│       └── site-packages/  # 安装的包
├── include/            # 头文件
└── pyvenv.cfg         # 配置文件
```

## 🐍 virtualenv - 第三方虚拟环境工具

### virtualenv的优势
```python
virtualenv_advantages = {
    "兼容性": "支持Python 2.7+和3.5+",
    "功能丰富": "比venv提供更多功能",
    "速度快": "创建环境速度更快",
    "可定制": "更多配置选项",
    "插件系统": "支持插件扩展"
}
```

### virtualenv使用
```bash
# 安装virtualenv
pip install virtualenv

# 创建虚拟环境
virtualenv myenv

# 指定Python版本
virtualenv -p python3.9 myenv

# 不安装setuptools和pip
virtualenv --no-setuptools --no-pip myenv

# 使用系统包
virtualenv --system-site-packages myenv

# 激活和停用（同venv）
source myenv/bin/activate  # Linux/Mac
myenv\Scripts\activate     # Windows
deactivate
```

## 🔧 virtualenvwrapper - 虚拟环境管理工具

### 安装和配置
```bash
# 安装virtualenvwrapper
pip install virtualenvwrapper

# 配置环境变量（添加到 ~/.bashrc 或 ~/.zshrc）
export WORKON_HOME=$HOME/.virtualenvs
export PROJECT_HOME=$HOME/Projects
source /usr/local/bin/virtualenvwrapper.sh

# Windows版本
pip install virtualenvwrapper-win
```

### virtualenvwrapper命令
```bash
# 创建环境
mkvirtualenv myproject

# 创建环境并关联项目目录
mkvirtualenv -a /path/to/project myproject

# 列出所有环境
lsvirtualenv

# 切换到环境
workon myproject

# 停用环境
deactivate

# 删除环境
rmvirtualenv myproject

# 进入项目目录
cdproject

# 设置项目目录
setvirtualenvproject
```

## 🐋 conda环境管理

### conda环境基础
```bash
# 创建环境
conda create -n myenv python=3.9

# 创建环境并安装包
conda create -n myenv python=3.9 numpy pandas

# 激活环境
conda activate myenv

# 停用环境
conda deactivate

# 列出环境
conda env list
conda info --envs

# 删除环境
conda env remove -n myenv
```

### conda环境高级功能
```bash
# 克隆环境
conda create -n newenv --clone oldenv

# 导出环境
conda env export > environment.yml
conda env export -n myenv > environment.yml

# 从文件创建环境
conda env create -f environment.yml

# 更新环境
conda env update -f environment.yml

# 环境历史
conda list --revisions
conda install --revision 2
```

## 🎭 pyenv - Python版本管理

### pyenv简介
pyenv允许你在同一系统上安装和管理多个Python版本。

### pyenv基础使用
```bash
# 安装pyenv（Linux/Mac）
curl https://pyenv.run | bash

# 列出可安装的Python版本
pyenv install --list

# 安装Python版本
pyenv install 3.9.7
pyenv install 3.10.0

# 列出已安装版本
pyenv versions

# 设置全局Python版本
pyenv global 3.9.7

# 设置本地项目Python版本
pyenv local 3.10.0

# 设置shell会话Python版本
pyenv shell 3.9.7

# 查看当前版本
pyenv version
```

### pyenv-virtualenv插件
```bash
# 创建虚拟环境
pyenv virtualenv 3.9.7 myproject

# 激活虚拟环境
pyenv activate myproject

# 停用虚拟环境
pyenv deactivate

# 删除虚拟环境
pyenv uninstall myproject

# 自动激活（在项目目录）
echo "myproject" > .python-version
```

## 📋 最佳实践

### 项目结构建议
```
my_project/
├── .python-version      # pyenv版本文件
├── requirements.txt     # 生产依赖
├── requirements-dev.txt # 开发依赖
├── .env                # 环境变量
├── .gitignore          # Git忽略文件
├── README.md           # 项目说明
├── src/                # 源代码
│   └── my_project/
├── tests/              # 测试代码
└── docs/               # 文档
```

### 环境管理工作流
```bash
# 1. 创建项目目录
mkdir my_project && cd my_project

# 2. 设置Python版本（如果使用pyenv）
pyenv local 3.9.7

# 3. 创建虚拟环境
python -m venv venv

# 4. 激活环境
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows

# 5. 升级pip
pip install --upgrade pip

# 6. 安装依赖
pip install -r requirements.txt

# 7. 开发完成后生成requirements.txt
pip freeze > requirements.txt

# 8. 停用环境
deactivate
```

### requirements.txt管理
```python
# 分层依赖管理
dependency_structure = {
    "requirements.txt": "生产环境依赖",
    "requirements-dev.txt": "开发环境依赖",
    "requirements-test.txt": "测试环境依赖",
    "requirements-docs.txt": "文档生成依赖"
}

# requirements-dev.txt 示例
"""
-r requirements.txt  # 包含生产依赖

# 开发工具
black>=22.0.0
flake8>=4.0.0
isort>=5.10.0
mypy>=0.950

# 测试工具
pytest>=7.0.0
pytest-cov>=3.0.0
pytest-mock>=3.7.0

# 文档工具
sphinx>=4.5.0
sphinx-rtd-theme>=1.0.0
"""
```

### 环境变量管理
```python
# .env 文件示例
"""
# 数据库配置
DATABASE_URL=sqlite:///app.db
DATABASE_DEBUG=True

# API配置
API_KEY=your_api_key_here
API_BASE_URL=https://api.example.com

# 应用配置
DEBUG=True
SECRET_KEY=your_secret_key
"""

# 在Python中使用
import os
from dotenv import load_dotenv

load_dotenv()  # 加载.env文件

DATABASE_URL = os.getenv('DATABASE_URL')
DEBUG = os.getenv('DEBUG', 'False').lower() == 'true'
```

## 🔍 故障排除

### 常见问题和解决方案
```python
common_issues = {
    "激活失败": {
        "问题": "source activate 命令不工作",
        "解决": "检查路径，使用完整路径激活脚本"
    },
    "包安装失败": {
        "问题": "pip install 失败",
        "解决": "升级pip，检查网络，使用国内镜像"
    },
    "Python版本错误": {
        "问题": "虚拟环境中Python版本不对",
        "解决": "重新创建环境，指定正确的Python版本"
    },
    "权限问题": {
        "问题": "没有权限安装包",
        "解决": "确保在虚拟环境中，避免使用sudo"
    },
    "环境变量问题": {
        "问题": "环境变量设置不生效",
        "解决": "检查shell配置文件，重新加载配置"
    }
}
```

### 调试命令
```bash
# 检查Python路径
which python
which pip

# 检查环境变量
echo $VIRTUAL_ENV
echo $PATH

# 检查已安装包
pip list
pip show package_name

# 检查pip配置
pip config list

# 验证虚拟环境
python -c "import sys; print(sys.prefix)"
```

## 🎯 本节小结

- **环境隔离**：虚拟环境解决依赖冲突和版本管理问题
- **工具选择**：venv、virtualenv、conda各有优势
- **版本管理**：pyenv管理多个Python版本
- **最佳实践**：规范的项目结构和工作流程
- **故障排除**：掌握常见问题的解决方法

## 💡 关键要点

1. **始终使用虚拟环境**：每个项目都应该有独立的虚拟环境
2. **选择合适工具**：根据需求选择venv、virtualenv或conda
3. **版本控制**：使用requirements.txt管理依赖
4. **环境变量**：使用.env文件管理配置
5. **文档记录**：在README中说明环境设置步骤

## 📚 延伸阅读
- [venv官方文档](https://docs.python.org/3/library/venv.html)
- [virtualenv文档](https://virtualenv.pypa.io/)
- [conda环境管理](https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html)
- [pyenv文档](https://github.com/pyenv/pyenv)
