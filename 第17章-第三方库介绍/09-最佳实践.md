# 09-最佳实践

## 🎯 包管理最佳实践

### 依赖管理原则
```python
dependency_principles = {
    "最小化原则": "只添加真正需要的依赖",
    "版本约束": "合理设置版本范围，避免过于严格或宽松",
    "安全优先": "定期检查和更新有安全漏洞的依赖",
    "兼容性": "考虑不同Python版本和平台的兼容性",
    "文档记录": "清楚记录依赖的用途和版本要求"
}
```

### 虚拟环境管理
```bash
# 项目级虚拟环境
# 每个项目都应该有独立的虚拟环境

# 创建项目目录
mkdir my_project && cd my_project

# 创建虚拟环境
python -m venv venv

# 激活环境
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows

# 安装项目依赖
pip install -r requirements.txt

# 开发完成后停用
deactivate
```

### requirements.txt管理
```txt
# requirements.txt - 生产依赖
requests>=2.25.0,<3.0.0
click>=7.0,<9.0.0
pydantic>=1.8.0,<2.0.0

# requirements-dev.txt - 开发依赖
-r requirements.txt  # 包含生产依赖

# 开发工具
black>=22.0.0
flake8>=4.0.0
isort>=5.10.0
mypy>=0.950

# 测试工具
pytest>=7.0.0
pytest-cov>=3.0.0
pytest-mock>=3.7.0

# 文档工具
sphinx>=4.5.0
sphinx-rtd-theme>=1.0.0
```

## 📦 包开发最佳实践

### 项目结构标准化
```
my_package/
├── pyproject.toml          # 项目配置（推荐）
├── setup.py               # 安装脚本（可选）
├── README.md              # 项目说明
├── LICENSE               # 许可证
├── CHANGELOG.md          # 更新日志
├── MANIFEST.in           # 包含文件清单
├── .gitignore           # Git忽略文件
├── .pre-commit-config.yaml  # 预提交钩子
├── src/                  # 源码目录（推荐）
│   └── my_package/
│       ├── __init__.py
│       ├── core.py
│       ├── utils.py
│       └── py.typed      # 类型提示标记
├── tests/                # 测试目录
│   ├── __init__.py
│   ├── conftest.py      # pytest配置
│   ├── test_core.py
│   └── test_utils.py
├── docs/                 # 文档目录
│   ├── conf.py          # Sphinx配置
│   ├── index.rst
│   └── api.rst
└── examples/             # 示例代码
    └── basic_usage.py
```

### 版本管理策略
```python
# 语义化版本控制
version_strategy = {
    "开发版本": {
        "格式": "1.0.0.dev1",
        "用途": "开发阶段，不发布",
        "递增": "每次开发构建递增"
    },
    "预发布版本": {
        "格式": "1.0.0a1, 1.0.0b1, 1.0.0rc1",
        "用途": "测试版本，可以发布",
        "递增": "alpha -> beta -> rc"
    },
    "正式版本": {
        "格式": "1.0.0",
        "用途": "生产环境使用",
        "递增": "MAJOR.MINOR.PATCH"
    }
}

# 自动版本管理
# 使用setuptools_scm从Git标签获取版本
# pyproject.toml
"""
[build-system]
requires = ["setuptools>=45", "setuptools_scm[toml]>=6.2"]

[tool.setuptools_scm]
write_to = "src/my_package/_version.py"
"""
```

### 代码质量保证
```toml
# pyproject.toml - 工具配置

# Black代码格式化
[tool.black]
line-length = 88
target-version = ['py38']
include = '\.pyi?$'

# isort导入排序
[tool.isort]
profile = "black"
multi_line_output = 3
line_length = 88
known_first_party = ["my_package"]

# mypy类型检查
[tool.mypy]
python_version = "3.8"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true

# pytest测试配置
[tool.pytest.ini_options]
minversion = "6.0"
addopts = "-ra -q --strict-markers --strict-config"
testpaths = ["tests"]
python_files = ["test_*.py", "*_test.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]

# coverage测试覆盖率
[tool.coverage.run]
source = ["src"]
omit = ["*/tests/*", "*/test_*.py"]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
]
```

## 🔒 安全最佳实践

### 依赖安全检查
```bash
# 使用safety检查已知漏洞
pip install safety
safety check

# 使用pip-audit检查依赖漏洞
pip install pip-audit
pip-audit

# 使用bandit检查代码安全
pip install bandit
bandit -r src/

# 定期更新依赖
pip list --outdated
pip install --upgrade package_name
```

### 安全配置
```python
# 安全最佳实践
security_practices = {
    "API密钥管理": "使用环境变量或密钥管理服务",
    "依赖审计": "定期检查依赖的安全漏洞",
    "版本锁定": "使用锁定文件确保依赖版本一致",
    "最小权限": "避免使用sudo安装包",
    "来源验证": "只从可信源安装包",
    "定期更新": "及时更新有安全修复的包"
}

# .env文件管理敏感信息
"""
# .env
DATABASE_URL=postgresql://user:pass@localhost/db
API_KEY=your_secret_api_key
DEBUG=False
"""

# 在代码中使用
"""
import os
from dotenv import load_dotenv

load_dotenv()

DATABASE_URL = os.getenv('DATABASE_URL')
API_KEY = os.getenv('API_KEY')
DEBUG = os.getenv('DEBUG', 'False').lower() == 'true'
"""
```

## 🚀 CI/CD最佳实践

### GitHub Actions工作流
```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, '3.10', 3.11]

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: Lint with flake8
      run: |
        flake8 src/ tests/
    
    - name: Check code formatting
      run: |
        black --check src/ tests/
    
    - name: Check import sorting
      run: |
        isort --check-only src/ tests/
    
    - name: Type checking
      run: |
        mypy src/
    
    - name: Test with pytest
      run: |
        pytest tests/ --cov=src/ --cov-report=xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
```

### 预提交钩子
```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files

  - repo: https://github.com/psf/black
    rev: 22.10.0
    hooks:
      - id: black

  - repo: https://github.com/pycqa/isort
    rev: 5.12.0
    hooks:
      - id: isort

  - repo: https://github.com/pycqa/flake8
    rev: 6.0.0
    hooks:
      - id: flake8

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v0.991
    hooks:
      - id: mypy
        additional_dependencies: [types-requests]
```

## 📚 文档最佳实践

### README.md模板
```markdown
# My Awesome Package

[![PyPI version](https://badge.fury.io/py/my-package.svg)](https://badge.fury.io/py/my-package)
[![Python versions](https://img.shields.io/pypi/pyversions/my-package.svg)](https://pypi.org/project/my-package/)
[![License](https://img.shields.io/pypi/l/my-package.svg)](https://github.com/username/my-package/blob/main/LICENSE)
[![Tests](https://github.com/username/my-package/workflows/CI/badge.svg)](https://github.com/username/my-package/actions)

简短的包描述，一句话说明包的用途。

## 特性

- ✨ 特性1：简洁的API设计
- 🚀 特性2：高性能实现
- 🔒 特性3：类型安全
- 📚 特性4：完整的文档

## 安装

```bash
pip install my-package
```

## 快速开始

```python
from my_package import MyClass

# 基本使用示例
obj = MyClass()
result = obj.do_something()
print(result)
```

## 文档

完整文档请访问：https://my-package.readthedocs.io/

## 贡献

欢迎贡献！请查看 [CONTRIBUTING.md](CONTRIBUTING.md) 了解如何参与开发。

## 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。
```

### API文档
```python
def calculate_compound_interest(
    principal: float,
    rate: float,
    time: float,
    compound_frequency: int = 1
) -> float:
    """
    计算复利
    
    使用复利公式计算投资的最终价值：A = P(1 + r/n)^(nt)
    
    Args:
        principal: 本金，必须为正数
        rate: 年利率，以小数形式表示（如0.05表示5%）
        time: 投资时间，以年为单位
        compound_frequency: 每年复利次数，默认为1
    
    Returns:
        复利计算后的最终金额
    
    Raises:
        ValueError: 当参数为负数或无效时
        TypeError: 当参数类型不正确时
    
    Examples:
        >>> calculate_compound_interest(1000, 0.05, 2)
        1102.5
        >>> calculate_compound_interest(1000, 0.05, 2, 4)
        1104.49
    
    Note:
        计算结果会四舍五入到小数点后2位
    """
    # 实现代码...
```

## 🎯 发布最佳实践

### 发布检查清单
```python
release_checklist = {
    "代码质量": [
        "✅ 所有测试通过",
        "✅ 代码覆盖率 > 80%",
        "✅ 代码格式化检查通过",
        "✅ 类型检查通过",
        "✅ 安全检查通过"
    ],
    "文档完整": [
        "✅ README.md更新",
        "✅ CHANGELOG.md更新",
        "✅ API文档生成",
        "✅ 示例代码测试"
    ],
    "版本管理": [
        "✅ 版本号更新",
        "✅ Git标签创建",
        "✅ 发布说明准备"
    ],
    "构建测试": [
        "✅ 本地构建成功",
        "✅ TestPyPI发布测试",
        "✅ 安装测试通过"
    ]
}
```

### 自动化发布脚本
```bash
#!/bin/bash
# release.sh - 自动化发布脚本

set -e

VERSION=$1
if [ -z "$VERSION" ]; then
    echo "用法: $0 <version>"
    exit 1
fi

echo "🚀 开始发布版本 $VERSION"

# 1. 代码质量检查
echo "🔍 代码质量检查..."
python -m pytest tests/ --cov=src/
python -m black --check src/ tests/
python -m flake8 src/ tests/
python -m mypy src/

# 2. 更新版本号
echo "📝 更新版本号..."
sed -i "s/version = \".*\"/version = \"$VERSION\"/" pyproject.toml

# 3. 构建包
echo "🏗️ 构建包..."
rm -rf dist/
python -m build

# 4. 检查构建产物
echo "🔍 检查构建产物..."
python -m twine check dist/*

# 5. 创建Git标签
echo "🏷️ 创建Git标签..."
git add pyproject.toml
git commit -m "Bump version to $VERSION"
git tag -a "v$VERSION" -m "Release version $VERSION"

# 6. 发布到PyPI
echo "🚀 发布到PyPI..."
python -m twine upload dist/*

# 7. 推送到远程仓库
echo "📤 推送到远程仓库..."
git push origin main
git push origin "v$VERSION"

echo "✅ 版本 $VERSION 发布成功！"
```

## 🎯 本节小结

- **标准化**：遵循Python社区的标准和约定
- **自动化**：使用工具自动化重复性任务
- **质量保证**：建立完整的质量检查流程
- **安全意识**：重视依赖和代码的安全性
- **文档完整**：提供清晰完整的文档

## 💡 关键要点

1. **一致性**：在项目中保持一致的标准和规范
2. **自动化**：使用CI/CD和工具自动化质量检查
3. **安全优先**：定期检查和更新依赖的安全漏洞
4. **文档驱动**：编写清晰完整的文档和示例
5. **社区参与**：积极参与Python社区，贡献和学习

## 📚 延伸阅读
- [Python包用户指南](https://packaging.python.org/)
- [Python开发最佳实践](https://docs.python-guide.org/)
- [PEP 8 - Python代码风格指南](https://peps.python.org/pep-0008/)
- [Python安全最佳实践](https://python-security.readthedocs.io/)

---
**章节总结**：通过本章的学习，你已经掌握了Python第三方库生态系统的核心知识和最佳实践，可以高效地管理依赖、开发包和参与开源社区。
