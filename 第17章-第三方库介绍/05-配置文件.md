# 05-é…ç½®æ–‡ä»¶

## ðŸ“„ é…ç½®æ–‡ä»¶æ¦‚è¿°

### PythonåŒ…é…ç½®æ–‡ä»¶çš„æ¼”è¿›
```python
config_evolution = {
    "setup.py": {
        "æ—¶æœŸ": "ä¼ ç»Ÿæ—¶æœŸï¼ˆ2000-2016ï¼‰",
        "ç‰¹ç‚¹": "Pythonä»£ç ï¼Œçµæ´»ä½†å¤æ‚",
        "çŠ¶æ€": "ä»åœ¨ä½¿ç”¨ï¼Œä½†ä¸æŽ¨èæ–°é¡¹ç›®"
    },
    "setup.cfg": {
        "æ—¶æœŸ": "è¿‡æ¸¡æ—¶æœŸï¼ˆ2016-2020ï¼‰",
        "ç‰¹ç‚¹": "INIæ ¼å¼ï¼Œå£°æ˜Žå¼é…ç½®",
        "çŠ¶æ€": "éƒ¨åˆ†ä½¿ç”¨ï¼Œé€æ¸è¢«æ›¿ä»£"
    },
    "pyproject.toml": {
        "æ—¶æœŸ": "çŽ°ä»£æ—¶æœŸï¼ˆ2020-è‡³ä»Šï¼‰",
        "ç‰¹ç‚¹": "TOMLæ ¼å¼ï¼Œæ ‡å‡†åŒ–é…ç½®",
        "çŠ¶æ€": "å®˜æ–¹æŽ¨èï¼ŒçŽ°ä»£é¡¹ç›®é¦–é€‰"
    }
}
```

### é…ç½®æ–‡ä»¶çš„ä½œç”¨
- **é¡¹ç›®å…ƒæ•°æ®**ï¼šåç§°ã€ç‰ˆæœ¬ã€ä½œè€…ç­‰ä¿¡æ¯
- **ä¾èµ–ç®¡ç†**ï¼šè¿è¡Œæ—¶å’Œå¼€å‘æ—¶ä¾èµ–
- **æž„å»ºé…ç½®**ï¼šå¦‚ä½•æž„å»ºå’Œæ‰“åŒ…é¡¹ç›®
- **å·¥å…·é…ç½®**ï¼šæµ‹è¯•ã€æ ¼å¼åŒ–ã€ç±»åž‹æ£€æŸ¥ç­‰å·¥å…·çš„é…ç½®

## ðŸ”§ pyproject.toml - çŽ°ä»£é…ç½®æ ‡å‡†

### åŸºæœ¬ç»“æž„
```toml
# pyproject.toml åŸºæœ¬ç»“æž„

[build-system]
# æž„å»ºç³»ç»Ÿé…ç½®

[project]
# é¡¹ç›®å…ƒæ•°æ®

[project.optional-dependencies]
# å¯é€‰ä¾èµ–

[project.scripts]
# å‘½ä»¤è¡Œè„šæœ¬

[project.gui-scripts]
# GUIè„šæœ¬

[project.entry-points]
# å…¥å£ç‚¹

[tool.setuptools]
# setuptoolsç‰¹å®šé…ç½®

[tool.setuptools.packages.find]
# åŒ…å‘çŽ°é…ç½®

[tool.setuptools.package-data]
# åŒ…æ•°æ®é…ç½®
```

### å®Œæ•´çš„pyproject.tomlç¤ºä¾‹
```toml
[build-system]
requires = ["setuptools>=61.0", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "my-awesome-package"
version = "1.0.0"
description = "A sample Python package"
readme = "README.md"
license = {file = "LICENSE"}
authors = [
    {name = "Your Name", email = "your.email@example.com"},
]
maintainers = [
    {name = "Maintainer Name", email = "maintainer@example.com"},
]
keywords = ["sample", "package", "example"]
classifiers = [
    "Development Status :: 4 - Beta",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: MIT License",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.8",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
]
requires-python = ">=3.8"
dependencies = [
    "requests>=2.25.0",
    "click>=7.0",
    "pydantic>=1.8.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=6.0",
    "pytest-cov>=3.0",
    "black>=22.0",
    "flake8>=4.0",
    "mypy>=0.950",
]
docs = [
    "sphinx>=4.0",
    "sphinx-rtd-theme>=1.0",
    "myst-parser>=0.17",
]
test = [
    "pytest>=6.0",
    "pytest-cov>=3.0",
    "pytest-mock>=3.7",
]

[project.urls]
Homepage = "https://github.com/yourusername/my-awesome-package"
Documentation = "https://my-awesome-package.readthedocs.io/"
Repository = "https://github.com/yourusername/my-awesome-package.git"
"Bug Tracker" = "https://github.com/yourusername/my-awesome-package/issues"
Changelog = "https://github.com/yourusername/my-awesome-package/blob/main/CHANGELOG.md"

[project.scripts]
my-tool = "my_package.cli:main"
my-admin = "my_package.admin:main"

[project.gui-scripts]
my-gui = "my_package.gui:main"

[project.entry-points."my_package.plugins"]
plugin1 = "my_package.plugins:plugin1"
plugin2 = "my_package.plugins:plugin2"

[tool.setuptools]
package-dir = {"" = "src"}

[tool.setuptools.packages.find]
where = ["src"]
include = ["my_package*"]
exclude = ["my_package.tests*"]

[tool.setuptools.package-data]
my_package = ["data/*.json", "templates/*.html"]

[tool.setuptools.dynamic]
version = {attr = "my_package.__version__"}
readme = {file = ["README.md"]}
```

### åŠ¨æ€é…ç½®
```toml
# åŠ¨æ€ç‰ˆæœ¬å’ŒREADME
[project]
name = "my-package"
dynamic = ["version", "readme"]

[tool.setuptools.dynamic]
version = {attr = "my_package.__version__"}
readme = {file = ["README.md"], content-type = "text/markdown"}

# æˆ–è€…ä½¿ç”¨setuptools_scm
[build-system]
requires = ["setuptools>=45", "setuptools_scm[toml]>=6.2"]

[tool.setuptools_scm]
write_to = "src/my_package/_version.py"
```

## ðŸ“‹ setup.cfg - ä¼ ç»Ÿå£°æ˜Žå¼é…ç½®

### setup.cfgåŸºæœ¬ç»“æž„
```ini
# setup.cfg ç¤ºä¾‹

[metadata]
name = my-package
version = 1.0.0
author = Your Name
author_email = your.email@example.com
description = A sample Python package
long_description = file: README.md
long_description_content_type = text/markdown
url = https://github.com/yourusername/my-package
project_urls =
    Bug Tracker = https://github.com/yourusername/my-package/issues
    Documentation = https://my-package.readthedocs.io/
classifiers =
    Programming Language :: Python :: 3
    License :: OSI Approved :: MIT License
    Operating System :: OS Independent

[options]
package_dir =
    = src
packages = find:
python_requires = >=3.8
install_requires =
    requests>=2.25.0
    click>=7.0

[options.packages.find]
where = src

[options.extras_require]
dev =
    pytest>=6.0
    black>=22.0
    flake8>=4.0
docs =
    sphinx>=4.0
    sphinx-rtd-theme

[options.entry_points]
console_scripts =
    my-tool = my_package.cli:main

[options.package_data]
my_package = data/*.json, templates/*.html
```

## ðŸ setup.py - ä¼ ç»Ÿç¼–ç¨‹å¼é…ç½®

### åŸºæœ¬setup.py
```python
#!/usr/bin/env python3
from setuptools import setup, find_packages
import pathlib

# è¯»å–READMEæ–‡ä»¶
here = pathlib.Path(__file__).parent.resolve()
long_description = (here / "README.md").read_text(encoding="utf-8")

# è¯»å–requirements.txt
def read_requirements(filename):
    with open(filename, 'r') as f:
        return [line.strip() for line in f if line.strip() and not line.startswith('#')]

setup(
    name="my-package",
    version="1.0.0",
    description="A sample Python package",
    long_description=long_description,
    long_description_content_type="text/markdown",
    url="https://github.com/yourusername/my-package",
    author="Your Name",
    author_email="your.email@example.com",
    classifiers=[
        "Development Status :: 4 - Beta",
        "Intended Audience :: Developers",
        "License :: OSI Approved :: MIT License",
        "Programming Language :: Python :: 3",
        "Programming Language :: Python :: 3.8",
        "Programming Language :: Python :: 3.9",
        "Programming Language :: Python :: 3.10",
        "Programming Language :: Python :: 3.11",
    ],
    keywords="sample, package, example",
    package_dir={"": "src"},
    packages=find_packages(where="src"),
    python_requires=">=3.8",
    install_requires=read_requirements("requirements.txt"),
    extras_require={
        "dev": read_requirements("requirements-dev.txt"),
        "test": read_requirements("requirements-test.txt"),
    },
    package_data={
        "my_package": ["data/*.json", "templates/*.html"],
    },
    entry_points={
        "console_scripts": [
            "my-tool=my_package.cli:main",
        ],
    },
    project_urls={
        "Bug Reports": "https://github.com/yourusername/my-package/issues",
        "Source": "https://github.com/yourusername/my-package/",
    },
)
```

### é«˜çº§setup.pyåŠŸèƒ½
```python
import os
import sys
from setuptools import setup, find_packages, Extension
from setuptools.command.build_ext import build_ext

# æ¡ä»¶ä¾èµ–
install_requires = ["requests>=2.25.0"]
if sys.version_info < (3, 9):
    install_requires.append("typing-extensions>=3.7.4")

# å¹³å°ç‰¹å®šä¾èµ–
extras_require = {
    "dev": ["pytest>=6.0", "black>=22.0"],
}
if os.name == "nt":  # Windows
    extras_require["dev"].append("colorama>=0.4.0")

# Cæ‰©å±•
ext_modules = [
    Extension(
        "my_package.fast_module",
        sources=["src/my_package/fast_module.c"],
        include_dirs=["src/my_package/include"],
    )
]

# è‡ªå®šä¹‰å‘½ä»¤
class CustomBuildExt(build_ext):
    def run(self):
        # è‡ªå®šä¹‰æž„å»ºé€»è¾‘
        super().run()

setup(
    name="my-package",
    # ... å…¶ä»–é…ç½®
    install_requires=install_requires,
    extras_require=extras_require,
    ext_modules=ext_modules,
    cmdclass={"build_ext": CustomBuildExt},
)
```

## ðŸ”§ å·¥å…·é…ç½®é›†æˆ

### åœ¨pyproject.tomlä¸­é…ç½®å¼€å‘å·¥å…·
```toml
# Blackä»£ç æ ¼å¼åŒ–
[tool.black]
line-length = 88
target-version = ['py38']
include = '\.pyi?$'
extend-exclude = '''
/(
  # directories
  \.eggs
  | \.git
  | \.hg
  | \.mypy_cache
  | \.tox
  | \.venv
  | build
  | dist
)/
'''

# isortå¯¼å…¥æŽ’åº
[tool.isort]
profile = "black"
multi_line_output = 3
line_length = 88
known_first_party = ["my_package"]

# mypyç±»åž‹æ£€æŸ¥
[tool.mypy]
python_version = "3.8"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true

[[tool.mypy.overrides]]
module = "tests.*"
disallow_untyped_defs = false

# pytestæµ‹è¯•é…ç½®
[tool.pytest.ini_options]
minversion = "6.0"
addopts = "-ra -q --strict-markers --strict-config"
testpaths = ["tests"]
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "integration: marks tests as integration tests",
]

# coverage.pyæµ‹è¯•è¦†ç›–çŽ‡
[tool.coverage.run]
source = ["my_package"]
omit = ["*/tests/*", "*/test_*.py"]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
]

# flake8ä»£ç æ£€æŸ¥ï¼ˆéœ€è¦å•ç‹¬çš„.flake8æ–‡ä»¶ï¼‰
# .flake8
[flake8]
max-line-length = 88
extend-ignore = E203, W503
exclude = .git,__pycache__,build,dist,.eggs
```

## ðŸ“Š é…ç½®æ–‡ä»¶å¯¹æ¯”

### åŠŸèƒ½å¯¹æ¯”
```python
config_comparison = {
    "ç‰¹æ€§": {
        "pyproject.toml": "çŽ°ä»£æ ‡å‡†ï¼ŒåŠŸèƒ½å®Œæ•´",
        "setup.cfg": "å£°æ˜Žå¼ï¼ŒåŠŸèƒ½æœ‰é™",
        "setup.py": "ç¼–ç¨‹å¼ï¼ŒåŠŸèƒ½å¼ºå¤§ä½†å¤æ‚"
    },
    "å¯è¯»æ€§": {
        "pyproject.toml": "TOMLæ ¼å¼ï¼Œæ¸…æ™°æ˜“è¯»",
        "setup.cfg": "INIæ ¼å¼ï¼Œç»“æž„æ¸…æ™°",
        "setup.py": "Pythonä»£ç ï¼Œéœ€è¦ç¼–ç¨‹çŸ¥è¯†"
    },
    "æ ‡å‡†åŒ–": {
        "pyproject.toml": "PEP 518/621æ ‡å‡†",
        "setup.cfg": "éƒ¨åˆ†æ ‡å‡†åŒ–",
        "setup.py": "ä¼ ç»Ÿæ–¹å¼ï¼Œç¼ºä¹æ ‡å‡†"
    },
    "å·¥å…·æ”¯æŒ": {
        "pyproject.toml": "çŽ°ä»£å·¥å…·å…¨é¢æ”¯æŒ",
        "setup.cfg": "éƒ¨åˆ†å·¥å…·æ”¯æŒ",
        "setup.py": "æ‰€æœ‰å·¥å…·æ”¯æŒ"
    }
}
```

### è¿ç§»å»ºè®®
```python
migration_path = {
    "æ–°é¡¹ç›®": "ç›´æŽ¥ä½¿ç”¨pyproject.toml",
    "çŽ°æœ‰setup.pyé¡¹ç›®": "é€æ­¥è¿ç§»åˆ°pyproject.toml",
    "å¤æ‚æž„å»ºéœ€æ±‚": "pyproject.toml + ç®€åŒ–çš„setup.py",
    "å›¢é˜Ÿåä½œ": "ç»Ÿä¸€ä½¿ç”¨pyproject.toml"
}
```

## ðŸŽ¯ æœ€ä½³å®žè·µ

### é…ç½®æ–‡ä»¶é€‰æ‹©
1. **æ–°é¡¹ç›®**ï¼šä¼˜å…ˆä½¿ç”¨`pyproject.toml`
2. **çŽ°æœ‰é¡¹ç›®**ï¼šé€æ­¥è¿ç§»åˆ°`pyproject.toml`
3. **å¤æ‚éœ€æ±‚**ï¼š`pyproject.toml` + æœ€å°åŒ–çš„`setup.py`
4. **å›¢é˜Ÿé¡¹ç›®**ï¼šç»Ÿä¸€é…ç½®æ ‡å‡†

### ç‰ˆæœ¬ç®¡ç†ç­–ç•¥
```toml
# é™æ€ç‰ˆæœ¬ï¼ˆç®€å•é¡¹ç›®ï¼‰
[project]
version = "1.0.0"

# åŠ¨æ€ç‰ˆæœ¬ï¼ˆä»Žä»£ç èŽ·å–ï¼‰
[project]
dynamic = ["version"]

[tool.setuptools.dynamic]
version = {attr = "my_package.__version__"}

# Gitæ ‡ç­¾ç‰ˆæœ¬ï¼ˆæŽ¨èï¼‰
[build-system]
requires = ["setuptools>=45", "setuptools_scm[toml]>=6.2"]

[tool.setuptools_scm]
```

### ä¾èµ–ç®¡ç†ç­–ç•¥
```toml
# å®½æ¾ç‰ˆæœ¬çº¦æŸï¼ˆåº“é¡¹ç›®ï¼‰
dependencies = [
    "requests>=2.25.0",
    "click>=7.0",
]

# ä¸¥æ ¼ç‰ˆæœ¬çº¦æŸï¼ˆåº”ç”¨é¡¹ç›®ï¼‰
dependencies = [
    "requests==2.28.1",
    "click==8.1.3",
]

# å…¼å®¹ç‰ˆæœ¬çº¦æŸï¼ˆæŽ¨èï¼‰
dependencies = [
    "requests>=2.25.0,<3.0.0",
    "click>=7.0,<9.0.0",
]
```

## ðŸŽ¯ æœ¬èŠ‚å°ç»“

- **çŽ°ä»£æ ‡å‡†**ï¼špyproject.tomlæ˜¯çŽ°ä»£Pythoné¡¹ç›®çš„é…ç½®æ ‡å‡†
- **é…ç½®å®Œæ•´**ï¼šåŒ…å«é¡¹ç›®å…ƒæ•°æ®ã€ä¾èµ–ã€æž„å»ºé…ç½®ç­‰
- **å·¥å…·é›†æˆ**ï¼šå¯ä»¥é…ç½®å„ç§å¼€å‘å·¥å…·
- **è¿ç§»è·¯å¾„**ï¼šä»Žä¼ ç»Ÿé…ç½®é€æ­¥è¿ç§»åˆ°çŽ°ä»£é…ç½®
- **æœ€ä½³å®žè·µ**ï¼šéµå¾ªç¤¾åŒºæ ‡å‡†å’Œæœ€ä½³å®žè·µ

## ðŸ’¡ å…³é”®è¦ç‚¹

1. **æ ‡å‡†é€‰æ‹©**ï¼šæ–°é¡¹ç›®ä¼˜å…ˆä½¿ç”¨pyproject.toml
2. **é…ç½®å®Œæ•´**ï¼šæä¾›å®Œæ•´çš„é¡¹ç›®å…ƒæ•°æ®
3. **ä¾èµ–æ˜Žç¡®**ï¼šåˆç†è®¾ç½®ä¾èµ–ç‰ˆæœ¬çº¦æŸ
4. **å·¥å…·é›†æˆ**ï¼šåœ¨åŒä¸€æ–‡ä»¶ä¸­é…ç½®å¼€å‘å·¥å…·
5. **ç‰ˆæœ¬ç­–ç•¥**ï¼šé€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

## ðŸ“š å»¶ä¼¸é˜…è¯»
- [PEP 518 - æž„å»ºç³»ç»Ÿè¦æ±‚](https://peps.python.org/pep-0518/)
- [PEP 621 - é¡¹ç›®å…ƒæ•°æ®](https://peps.python.org/pep-0621/)
- [setuptoolsæ–‡æ¡£](https://setuptools.pypa.io/en/latest/)
- [TOMLæ ¼å¼è§„èŒƒ](https://toml.io/)

---
**ä¸‹ä¸€èŠ‚é¢„å‘Š**ï¼š06-æž„å»ºå’Œåˆ†å‘ - å­¦ä¹ å¦‚ä½•æž„å»ºå’Œåˆ†å‘PythonåŒ…
