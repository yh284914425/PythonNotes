# 05-配置文件

## 📄 配置文件概述

### Python包配置文件的演进
```python
config_evolution = {
    "setup.py": {
        "时期": "传统时期（2000-2016）",
        "特点": "Python代码，灵活但复杂",
        "状态": "仍在使用，但不推荐新项目"
    },
    "setup.cfg": {
        "时期": "过渡时期（2016-2020）",
        "特点": "INI格式，声明式配置",
        "状态": "部分使用，逐渐被替代"
    },
    "pyproject.toml": {
        "时期": "现代时期（2020-至今）",
        "特点": "TOML格式，标准化配置",
        "状态": "官方推荐，现代项目首选"
    }
}
```

### 配置文件的作用
- **项目元数据**：名称、版本、作者等信息
- **依赖管理**：运行时和开发时依赖
- **构建配置**：如何构建和打包项目
- **工具配置**：测试、格式化、类型检查等工具的配置

## 🔧 pyproject.toml - 现代配置标准

### 基本结构
```toml
# pyproject.toml 基本结构

[build-system]
# 构建系统配置

[project]
# 项目元数据

[project.optional-dependencies]
# 可选依赖

[project.scripts]
# 命令行脚本

[project.gui-scripts]
# GUI脚本

[project.entry-points]
# 入口点

[tool.setuptools]
# setuptools特定配置

[tool.setuptools.packages.find]
# 包发现配置

[tool.setuptools.package-data]
# 包数据配置
```

### 完整的pyproject.toml示例
```toml
[build-system]
requires = ["setuptools>=61.0", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "my-awesome-package"
version = "1.0.0"
description = "A sample Python package"
readme = "README.md"
license = {file = "LICENSE"}
authors = [
    {name = "Your Name", email = "your.email@example.com"},
]
maintainers = [
    {name = "Maintainer Name", email = "maintainer@example.com"},
]
keywords = ["sample", "package", "example"]
classifiers = [
    "Development Status :: 4 - Beta",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: MIT License",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.8",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
]
requires-python = ">=3.8"
dependencies = [
    "requests>=2.25.0",
    "click>=7.0",
    "pydantic>=1.8.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=6.0",
    "pytest-cov>=3.0",
    "black>=22.0",
    "flake8>=4.0",
    "mypy>=0.950",
]
docs = [
    "sphinx>=4.0",
    "sphinx-rtd-theme>=1.0",
    "myst-parser>=0.17",
]
test = [
    "pytest>=6.0",
    "pytest-cov>=3.0",
    "pytest-mock>=3.7",
]

[project.urls]
Homepage = "https://github.com/yourusername/my-awesome-package"
Documentation = "https://my-awesome-package.readthedocs.io/"
Repository = "https://github.com/yourusername/my-awesome-package.git"
"Bug Tracker" = "https://github.com/yourusername/my-awesome-package/issues"
Changelog = "https://github.com/yourusername/my-awesome-package/blob/main/CHANGELOG.md"

[project.scripts]
my-tool = "my_package.cli:main"
my-admin = "my_package.admin:main"

[project.gui-scripts]
my-gui = "my_package.gui:main"

[project.entry-points."my_package.plugins"]
plugin1 = "my_package.plugins:plugin1"
plugin2 = "my_package.plugins:plugin2"

[tool.setuptools]
package-dir = {"" = "src"}

[tool.setuptools.packages.find]
where = ["src"]
include = ["my_package*"]
exclude = ["my_package.tests*"]

[tool.setuptools.package-data]
my_package = ["data/*.json", "templates/*.html"]

[tool.setuptools.dynamic]
version = {attr = "my_package.__version__"}
readme = {file = ["README.md"]}
```

### 动态配置
```toml
# 动态版本和README
[project]
name = "my-package"
dynamic = ["version", "readme"]

[tool.setuptools.dynamic]
version = {attr = "my_package.__version__"}
readme = {file = ["README.md"], content-type = "text/markdown"}

# 或者使用setuptools_scm
[build-system]
requires = ["setuptools>=45", "setuptools_scm[toml]>=6.2"]

[tool.setuptools_scm]
write_to = "src/my_package/_version.py"
```

## 📋 setup.cfg - 传统声明式配置

### setup.cfg基本结构
```ini
# setup.cfg 示例

[metadata]
name = my-package
version = 1.0.0
author = Your Name
author_email = your.email@example.com
description = A sample Python package
long_description = file: README.md
long_description_content_type = text/markdown
url = https://github.com/yourusername/my-package
project_urls =
    Bug Tracker = https://github.com/yourusername/my-package/issues
    Documentation = https://my-package.readthedocs.io/
classifiers =
    Programming Language :: Python :: 3
    License :: OSI Approved :: MIT License
    Operating System :: OS Independent

[options]
package_dir =
    = src
packages = find:
python_requires = >=3.8
install_requires =
    requests>=2.25.0
    click>=7.0

[options.packages.find]
where = src

[options.extras_require]
dev =
    pytest>=6.0
    black>=22.0
    flake8>=4.0
docs =
    sphinx>=4.0
    sphinx-rtd-theme

[options.entry_points]
console_scripts =
    my-tool = my_package.cli:main

[options.package_data]
my_package = data/*.json, templates/*.html
```

## 🐍 setup.py - 传统编程式配置

### 基本setup.py
```python
#!/usr/bin/env python3
from setuptools import setup, find_packages
import pathlib

# 读取README文件
here = pathlib.Path(__file__).parent.resolve()
long_description = (here / "README.md").read_text(encoding="utf-8")

# 读取requirements.txt
def read_requirements(filename):
    with open(filename, 'r') as f:
        return [line.strip() for line in f if line.strip() and not line.startswith('#')]

setup(
    name="my-package",
    version="1.0.0",
    description="A sample Python package",
    long_description=long_description,
    long_description_content_type="text/markdown",
    url="https://github.com/yourusername/my-package",
    author="Your Name",
    author_email="your.email@example.com",
    classifiers=[
        "Development Status :: 4 - Beta",
        "Intended Audience :: Developers",
        "License :: OSI Approved :: MIT License",
        "Programming Language :: Python :: 3",
        "Programming Language :: Python :: 3.8",
        "Programming Language :: Python :: 3.9",
        "Programming Language :: Python :: 3.10",
        "Programming Language :: Python :: 3.11",
    ],
    keywords="sample, package, example",
    package_dir={"": "src"},
    packages=find_packages(where="src"),
    python_requires=">=3.8",
    install_requires=read_requirements("requirements.txt"),
    extras_require={
        "dev": read_requirements("requirements-dev.txt"),
        "test": read_requirements("requirements-test.txt"),
    },
    package_data={
        "my_package": ["data/*.json", "templates/*.html"],
    },
    entry_points={
        "console_scripts": [
            "my-tool=my_package.cli:main",
        ],
    },
    project_urls={
        "Bug Reports": "https://github.com/yourusername/my-package/issues",
        "Source": "https://github.com/yourusername/my-package/",
    },
)
```

### 高级setup.py功能
```python
import os
import sys
from setuptools import setup, find_packages, Extension
from setuptools.command.build_ext import build_ext

# 条件依赖
install_requires = ["requests>=2.25.0"]
if sys.version_info < (3, 9):
    install_requires.append("typing-extensions>=3.7.4")

# 平台特定依赖
extras_require = {
    "dev": ["pytest>=6.0", "black>=22.0"],
}
if os.name == "nt":  # Windows
    extras_require["dev"].append("colorama>=0.4.0")

# C扩展
ext_modules = [
    Extension(
        "my_package.fast_module",
        sources=["src/my_package/fast_module.c"],
        include_dirs=["src/my_package/include"],
    )
]

# 自定义命令
class CustomBuildExt(build_ext):
    def run(self):
        # 自定义构建逻辑
        super().run()

setup(
    name="my-package",
    # ... 其他配置
    install_requires=install_requires,
    extras_require=extras_require,
    ext_modules=ext_modules,
    cmdclass={"build_ext": CustomBuildExt},
)
```

## 🔧 工具配置集成

### 在pyproject.toml中配置开发工具
```toml
# Black代码格式化
[tool.black]
line-length = 88
target-version = ['py38']
include = '\.pyi?$'
extend-exclude = '''
/(
  # directories
  \.eggs
  | \.git
  | \.hg
  | \.mypy_cache
  | \.tox
  | \.venv
  | build
  | dist
)/
'''

# isort导入排序
[tool.isort]
profile = "black"
multi_line_output = 3
line_length = 88
known_first_party = ["my_package"]

# mypy类型检查
[tool.mypy]
python_version = "3.8"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true

[[tool.mypy.overrides]]
module = "tests.*"
disallow_untyped_defs = false

# pytest测试配置
[tool.pytest.ini_options]
minversion = "6.0"
addopts = "-ra -q --strict-markers --strict-config"
testpaths = ["tests"]
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "integration: marks tests as integration tests",
]

# coverage.py测试覆盖率
[tool.coverage.run]
source = ["my_package"]
omit = ["*/tests/*", "*/test_*.py"]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
]

# flake8代码检查（需要单独的.flake8文件）
# .flake8
[flake8]
max-line-length = 88
extend-ignore = E203, W503
exclude = .git,__pycache__,build,dist,.eggs
```

## 📊 配置文件对比

### 功能对比
```python
config_comparison = {
    "特性": {
        "pyproject.toml": "现代标准，功能完整",
        "setup.cfg": "声明式，功能有限",
        "setup.py": "编程式，功能强大但复杂"
    },
    "可读性": {
        "pyproject.toml": "TOML格式，清晰易读",
        "setup.cfg": "INI格式，结构清晰",
        "setup.py": "Python代码，需要编程知识"
    },
    "标准化": {
        "pyproject.toml": "PEP 518/621标准",
        "setup.cfg": "部分标准化",
        "setup.py": "传统方式，缺乏标准"
    },
    "工具支持": {
        "pyproject.toml": "现代工具全面支持",
        "setup.cfg": "部分工具支持",
        "setup.py": "所有工具支持"
    }
}
```

### 迁移建议
```python
migration_path = {
    "新项目": "直接使用pyproject.toml",
    "现有setup.py项目": "逐步迁移到pyproject.toml",
    "复杂构建需求": "pyproject.toml + 简化的setup.py",
    "团队协作": "统一使用pyproject.toml"
}
```

## 🎯 最佳实践

### 配置文件选择
1. **新项目**：优先使用`pyproject.toml`
2. **现有项目**：逐步迁移到`pyproject.toml`
3. **复杂需求**：`pyproject.toml` + 最小化的`setup.py`
4. **团队项目**：统一配置标准

### 版本管理策略
```toml
# 静态版本（简单项目）
[project]
version = "1.0.0"

# 动态版本（从代码获取）
[project]
dynamic = ["version"]

[tool.setuptools.dynamic]
version = {attr = "my_package.__version__"}

# Git标签版本（推荐）
[build-system]
requires = ["setuptools>=45", "setuptools_scm[toml]>=6.2"]

[tool.setuptools_scm]
```

### 依赖管理策略
```toml
# 宽松版本约束（库项目）
dependencies = [
    "requests>=2.25.0",
    "click>=7.0",
]

# 严格版本约束（应用项目）
dependencies = [
    "requests==2.28.1",
    "click==8.1.3",
]

# 兼容版本约束（推荐）
dependencies = [
    "requests>=2.25.0,<3.0.0",
    "click>=7.0,<9.0.0",
]
```

## 🎯 本节小结

- **现代标准**：pyproject.toml是现代Python项目的配置标准
- **配置完整**：包含项目元数据、依赖、构建配置等
- **工具集成**：可以配置各种开发工具
- **迁移路径**：从传统配置逐步迁移到现代配置
- **最佳实践**：遵循社区标准和最佳实践

## 💡 关键要点

1. **标准选择**：新项目优先使用pyproject.toml
2. **配置完整**：提供完整的项目元数据
3. **依赖明确**：合理设置依赖版本约束
4. **工具集成**：在同一文件中配置开发工具
5. **版本策略**：选择合适的版本管理策略

## 📚 延伸阅读
- [PEP 518 - 构建系统要求](https://peps.python.org/pep-0518/)
- [PEP 621 - 项目元数据](https://peps.python.org/pep-0621/)
- [setuptools文档](https://setuptools.pypa.io/en/latest/)
- [TOML格式规范](https://toml.io/)

---
**下一节预告**：06-构建和分发 - 学习如何构建和分发Python包
