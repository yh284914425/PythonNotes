# 03-创建模块

## 🔧 创建自定义模块

### 基本步骤
1. 创建一个`.py`文件
2. 在文件中定义函数、类或变量
3. 添加文档字符串
4. 在其他文件中导入使用

### 示例：创建数学工具模块

**创建文件：math_tools.py**
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
math_tools.py - 数学工具模块

提供常用的数学计算功能，包括：
- 基本运算
- 几何计算
- 数论函数

作者: Python学习者
版本: 1.0.0
"""

import math

# 模块级常量
PI = 3.14159265359
E = 2.71828182846

def add(a, b):
    """
    加法运算
    
    Args:
        a (float): 第一个数
        b (float): 第二个数
    
    Returns:
        float: 两数之和
    
    Examples:
        >>> add(2, 3)
        5
        >>> add(-1, 1)
        0
    """
    return a + b

def multiply(a, b):
    """乘法运算"""
    return a * b

def circle_area(radius):
    """
    计算圆的面积
    
    Args:
        radius (float): 圆的半径
    
    Returns:
        float: 圆的面积
    
    Raises:
        ValueError: 当半径为负数时
    """
    if radius < 0:
        raise ValueError("半径不能为负数")
    return PI * radius ** 2

def is_prime(n):
    """
    判断是否为质数
    
    Args:
        n (int): 待判断的整数
    
    Returns:
        bool: 如果是质数返回True，否则返回False
    """
    if n < 2:
        return False
    for i in range(2, int(n ** 0.5) + 1):
        if n % i == 0:
            return False
    return True

class Calculator:
    """简单计算器类"""
    
    def __init__(self):
        self.result = 0
        self.history = []
    
    def add(self, value):
        """加法操作"""
        self.result += value
        self.history.append(f"+ {value} = {self.result}")
        return self.result
    
    def clear(self):
        """清空计算器"""
        self.result = 0
        self.history.clear()

# 模块测试代码
def _test():
    """模块测试函数"""
    print("测试math_tools模块:")
    print(f"5 + 3 = {add(5, 3)}")
    print(f"半径为3的圆面积 = {circle_area(3):.2f}")
    print(f"17是质数: {is_prime(17)}")
    
    calc = Calculator()
    calc.add(10)
    calc.add(5)
    print(f"计算器结果: {calc.result}")

# 当模块被直接运行时执行测试
if __name__ == "__main__":
    _test()
```

### 使用自定义模块

**在其他文件中使用：**
```python
# main.py
import math_tools

# 使用模块中的函数
result = math_tools.add(10, 20)
print(f"10 + 20 = {result}")

# 使用模块中的常量
print(f"PI的值: {math_tools.PI}")

# 使用模块中的类
calc = math_tools.Calculator()
calc.add(100)
print(f"计算结果: {calc.result}")

# 或者使用from...import
from math_tools import circle_area, is_prime
print(f"半径为5的圆面积: {circle_area(5)}")
print(f"29是质数: {is_prime(29)}")
```

## 📝 模块文档规范

### 1. 模块级文档字符串
```python
"""
模块名 - 简短描述

详细描述模块的功能、用途和使用方法。

模块包含的主要功能：
- 功能1：描述
- 功能2：描述
- 功能3：描述

使用示例:
    import my_module
    result = my_module.some_function(arg1, arg2)

作者: 作者姓名
邮箱: author@example.com
版本: 1.0.0
创建日期: 2024-01-01
最后修改: 2024-01-15
许可证: MIT
"""
```

### 2. 函数文档字符串
```python
def calculate_distance(x1, y1, x2, y2):
    """
    计算两点之间的欧几里得距离
    
    Args:
        x1 (float): 第一个点的x坐标
        y1 (float): 第一个点的y坐标
        x2 (float): 第二个点的x坐标
        y2 (float): 第二个点的y坐标
    
    Returns:
        float: 两点之间的距离
    
    Raises:
        TypeError: 当输入不是数字时
        ValueError: 当坐标值无效时
    
    Examples:
        >>> calculate_distance(0, 0, 3, 4)
        5.0
        >>> calculate_distance(1, 1, 4, 5)
        5.0
    
    Note:
        使用欧几里得距离公式: sqrt((x2-x1)² + (y2-y1)²)
    """
    import math
    return math.sqrt((x2 - x1)**2 + (y2 - y1)**2)
```

### 3. 类文档字符串
```python
class BankAccount:
    """
    银行账户类
    
    用于模拟银行账户的基本操作，包括存款、取款和查询余额。
    
    Attributes:
        account_number (str): 账户号码
        balance (float): 账户余额
        owner (str): 账户所有者
    
    Examples:
        >>> account = BankAccount("123456", "张三", 1000)
        >>> account.deposit(500)
        1500.0
        >>> account.withdraw(200)
        1300.0
    """
    
    def __init__(self, account_number, owner, initial_balance=0):
        """
        初始化银行账户
        
        Args:
            account_number (str): 账户号码
            owner (str): 账户所有者
            initial_balance (float, optional): 初始余额，默认为0
        """
        self.account_number = account_number
        self.owner = owner
        self.balance = initial_balance
```

## 🏗️ 模块结构最佳实践

### 1. 标准模块结构
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""模块文档字符串"""

# 1. 导入标准库
import os
import sys
from datetime import datetime

# 2. 导入第三方库
import requests
import numpy as np

# 3. 导入本地模块
from .utils import helper_function

# 4. 模块级常量（全大写）
DEFAULT_TIMEOUT = 30
MAX_RETRIES = 3
API_VERSION = "v1"

# 5. 模块级变量
_private_cache = {}
public_config = {}

# 6. 异常类定义
class CustomError(Exception):
    """自定义异常类"""
    pass

# 7. 私有函数（以下划线开头）
def _internal_helper():
    """内部辅助函数"""
    pass

# 8. 公共函数
def public_function():
    """公共函数"""
    pass

# 9. 类定义
class PublicClass:
    """公共类"""
    pass

# 10. 主程序入口
def main():
    """主函数"""
    pass

# 11. 模块测试代码
if __name__ == "__main__":
    main()
```

### 2. __all__ 变量的使用
```python
# 定义模块的公共接口
__all__ = [
    'public_function',
    'PublicClass',
    'DEFAULT_TIMEOUT',
    'CustomError'
]

# 这样from module import * 只会导入__all__中的内容
```

### 3. 版本信息管理
```python
# version.py 或在主模块中
__version__ = "1.2.3"
__author__ = "Your Name"
__email__ = "your.email@example.com"
__license__ = "MIT"

# 版本信息函数
def get_version():
    """获取版本信息"""
    return {
        'version': __version__,
        'author': __author__,
        'email': __email__,
        'license': __license__
    }
```

## 🧪 模块测试

### 1. 内置测试
```python
def _test_functions():
    """测试模块中的函数"""
    # 测试add函数
    assert add(2, 3) == 5, "add函数测试失败"
    assert add(-1, 1) == 0, "add函数负数测试失败"
    
    # 测试circle_area函数
    area = circle_area(1)
    assert abs(area - PI) < 0.001, "circle_area函数测试失败"
    
    print("所有测试通过!")

if __name__ == "__main__":
    _test_functions()
```

### 2. 使用doctest
```python
def factorial(n):
    """
    计算阶乘
    
    >>> factorial(5)
    120
    >>> factorial(0)
    1
    >>> factorial(1)
    1
    """
    if n <= 1:
        return 1
    return n * factorial(n - 1)

if __name__ == "__main__":
    import doctest
    doctest.testmod()  # 运行文档字符串中的测试
```

### 3. 单元测试
```python
# test_math_tools.py
import unittest
from math_tools import add, circle_area, is_prime

class TestMathTools(unittest.TestCase):
    
    def test_add(self):
        """测试加法函数"""
        self.assertEqual(add(2, 3), 5)
        self.assertEqual(add(-1, 1), 0)
        self.assertEqual(add(0, 0), 0)
    
    def test_circle_area(self):
        """测试圆面积计算"""
        self.assertAlmostEqual(circle_area(1), 3.14159, places=4)
        with self.assertRaises(ValueError):
            circle_area(-1)
    
    def test_is_prime(self):
        """测试质数判断"""
        self.assertTrue(is_prime(17))
        self.assertFalse(is_prime(18))
        self.assertFalse(is_prime(1))

if __name__ == "__main__":
    unittest.main()
```

## 🔧 模块配置和设置

### 1. 配置文件支持
```python
# config.py
import os
import json

class Config:
    """配置管理类"""
    
    def __init__(self, config_file='config.json'):
        self.config_file = config_file
        self.settings = self.load_config()
    
    def load_config(self):
        """加载配置文件"""
        if os.path.exists(self.config_file):
            with open(self.config_file, 'r') as f:
                return json.load(f)
        return self.get_default_config()
    
    def get_default_config(self):
        """获取默认配置"""
        return {
            'debug': False,
            'timeout': 30,
            'max_retries': 3
        }
    
    def get(self, key, default=None):
        """获取配置项"""
        return self.settings.get(key, default)

# 全局配置实例
config = Config()
```

### 2. 环境变量支持
```python
import os

# 从环境变量读取配置
DEBUG = os.getenv('DEBUG', 'False').lower() == 'true'
DATABASE_URL = os.getenv('DATABASE_URL', 'sqlite:///default.db')
SECRET_KEY = os.getenv('SECRET_KEY', 'default-secret-key')

def get_config():
    """获取配置信息"""
    return {
        'debug': DEBUG,
        'database_url': DATABASE_URL,
        'secret_key': SECRET_KEY
    }
```

## 🎯 本节小结

- **创建步骤**：创建.py文件，定义函数/类，添加文档，导入使用
- **文档规范**：模块、函数、类都要有清晰的文档字符串
- **结构最佳实践**：遵循标准结构，使用__all__定义公共接口
- **测试方法**：内置测试、doctest、单元测试
- **配置管理**：支持配置文件和环境变量

## 📚 下一步学习
学习完创建模块后，接下来学习 **[04-包的概念.md](./04-包的概念.md)**，了解如何组织多个模块。
