# 06-打包实践

## 📦 项目打包概述

在前面的章节中，我们已经完成了TaskMaster项目的核心功能开发、测试和文档编写。现在是时候将项目打包成可分发的Python包了。

### 打包的目标
```python
packaging_goals = {
    "用户安装": "用户可以通过pip install taskmaster安装",
    "命令行工具": "安装后可以直接使用taskmaster命令",
    "依赖管理": "自动安装和管理项目依赖",
    "跨平台": "支持Windows、macOS、Linux",
    "版本管理": "支持多版本并存和升级"
}
```

## 🏗️ 项目结构整理

### 标准化项目结构
首先，让我们确保项目结构符合Python包的标准：

```
taskmaster/
├── pyproject.toml          # 项目配置文件
├── README.md              # 项目说明
├── LICENSE               # 许可证文件
├── CHANGELOG.md          # 更新日志
├── MANIFEST.in           # 包含文件清单
├── .gitignore           # Git忽略文件
├── src/                  # 源码目录
│   └── taskmaster/
│       ├── __init__.py
│       ├── cli.py        # 命令行接口
│       ├── models.py     # 数据模型
│       ├── storage.py    # 数据存储
│       ├── utils.py      # 工具函数
│       └── py.typed      # 类型提示标记
├── tests/                # 测试目录
│   ├── __init__.py
│   ├── conftest.py
│   ├── test_models.py
│   ├── test_storage.py
│   ├── test_cli.py
│   └── test_utils.py
├── docs/                 # 文档目录
│   ├── conf.py
│   ├── index.rst
│   └── api.rst
└── examples/             # 示例代码
    └── basic_usage.py
```

### 创建必要文件

#### 1. 创建py.typed文件
```bash
# 标记包支持类型提示
touch src/taskmaster/py.typed
```

#### 2. 更新__init__.py
```python
# src/taskmaster/__init__.py
"""
TaskMaster - 一个简单而强大的任务管理工具

TaskMaster是一个命令行任务管理工具，帮助你高效地管理个人任务和待办事项。
"""

__version__ = "1.0.0"
__author__ = "Your Name"
__email__ = "your.email@example.com"

from .models import Task, TaskStatus, Priority
from .storage import TaskStorage
from .cli import main

__all__ = [
    "Task",
    "TaskStatus", 
    "Priority",
    "TaskStorage",
    "main",
    "__version__",
]
```

## ⚙️ 配置pyproject.toml

### 完整的项目配置
```toml
# pyproject.toml
[build-system]
requires = ["setuptools>=61.0", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "taskmaster"
version = "1.0.0"
description = "一个简单而强大的命令行任务管理工具"
readme = "README.md"
license = {file = "LICENSE"}
authors = [
    {name = "Your Name", email = "your.email@example.com"},
]
maintainers = [
    {name = "Your Name", email = "your.email@example.com"},
]
keywords = ["task", "todo", "cli", "productivity", "management"]
classifiers = [
    "Development Status :: 5 - Production/Stable",
    "Environment :: Console",
    "Intended Audience :: End Users/Desktop",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: MIT License",
    "Operating System :: OS Independent",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.8",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Topic :: Office/Business :: Scheduling",
    "Topic :: Utilities",
    "Typing :: Typed",
]
requires-python = ">=3.8"
dependencies = [
    "click>=8.0.0",
    "pydantic>=1.8.0",
    "rich>=12.0.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=7.0.0",
    "pytest-cov>=3.0.0",
    "pytest-mock>=3.7.0",
    "black>=22.0.0",
    "flake8>=4.0.0",
    "isort>=5.10.0",
    "mypy>=0.950",
]
docs = [
    "sphinx>=4.5.0",
    "sphinx-rtd-theme>=1.0.0",
    "sphinx-click>=4.0.0",
]
test = [
    "pytest>=7.0.0",
    "pytest-cov>=3.0.0",
    "pytest-mock>=3.7.0",
]

[project.urls]
Homepage = "https://github.com/yourusername/taskmaster"
Documentation = "https://taskmaster.readthedocs.io/"
Repository = "https://github.com/yourusername/taskmaster.git"
"Bug Tracker" = "https://github.com/yourusername/taskmaster/issues"
Changelog = "https://github.com/yourusername/taskmaster/blob/main/CHANGELOG.md"

[project.scripts]
taskmaster = "taskmaster.cli:main"
tm = "taskmaster.cli:main"

[tool.setuptools]
package-dir = {"" = "src"}

[tool.setuptools.packages.find]
where = ["src"]
include = ["taskmaster*"]

[tool.setuptools.package-data]
taskmaster = ["py.typed"]

# 开发工具配置
[tool.black]
line-length = 88
target-version = ['py38']
include = '\.pyi?$'
extend-exclude = '''
/(
  \.eggs
  | \.git
  | \.hg
  | \.mypy_cache
  | \.tox
  | \.venv
  | build
  | dist
)/
'''

[tool.isort]
profile = "black"
multi_line_output = 3
line_length = 88
known_first_party = ["taskmaster"]

[tool.mypy]
python_version = "3.8"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
mypy_path = "src"

[[tool.mypy.overrides]]
module = "tests.*"
disallow_untyped_defs = false

[tool.pytest.ini_options]
minversion = "7.0"
addopts = "-ra -q --strict-markers --strict-config"
testpaths = ["tests"]
python_files = ["test_*.py", "*_test.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "integration: marks tests as integration tests",
]

[tool.coverage.run]
source = ["src"]
omit = ["*/tests/*", "*/test_*.py"]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
]
```

## 📋 创建MANIFEST.in

### 包含文件清单
```
# MANIFEST.in - 控制源码包包含的文件

# 包含重要文件
include README.md
include LICENSE
include CHANGELOG.md
include pyproject.toml

# 包含数据文件
recursive-include src/taskmaster *.py
include src/taskmaster/py.typed

# 包含文档
recursive-include docs *.rst *.md *.py
recursive-include docs/_static *
recursive-include docs/_templates *

# 包含示例
recursive-include examples *.py

# 包含测试文件（可选）
recursive-include tests *.py

# 排除不需要的文件
exclude .gitignore
exclude .pre-commit-config.yaml
exclude tox.ini
exclude Makefile
exclude *.cfg

# 排除目录
prune .git
prune .github
prune .pytest_cache
prune .mypy_cache
prune build
prune dist
prune *.egg-info

# 全局排除
global-exclude *.pyc
global-exclude __pycache__
global-exclude .DS_Store
global-exclude *.so
global-exclude *.pyd
```

## 🔧 命令行入口配置

### CLI模块优化
```python
# src/taskmaster/cli.py
"""
TaskMaster命令行接口

提供完整的命令行功能，包括任务的增删改查、状态管理等。
"""

import click
from typing import Optional
from .models import Task, TaskStatus, Priority
from .storage import TaskStorage
from . import __version__

# 创建全局存储实例
storage = TaskStorage()

@click.group()
@click.version_option(version=__version__, prog_name="taskmaster")
@click.pass_context
def main(ctx):
    """TaskMaster - 简单而强大的任务管理工具"""
    ctx.ensure_object(dict)
    ctx.obj['storage'] = storage

@main.command()
@click.argument('title')
@click.option('--description', '-d', help='任务描述')
@click.option('--priority', '-p', 
              type=click.Choice(['low', 'medium', 'high']), 
              default='medium', help='任务优先级')
@click.option('--tags', '-t', help='任务标签，用逗号分隔')
@click.pass_context
def add(ctx, title: str, description: Optional[str], 
        priority: str, tags: Optional[str]):
    """添加新任务"""
    task_tags = [tag.strip() for tag in tags.split(',')] if tags else []
    
    task = Task(
        title=title,
        description=description or "",
        priority=Priority(priority),
        tags=task_tags
    )
    
    task_id = ctx.obj['storage'].add_task(task)
    click.echo(f"✅ 任务已添加，ID: {task_id}")

@main.command()
@click.option('--status', '-s', 
              type=click.Choice(['todo', 'doing', 'done']),
              help='按状态过滤')
@click.option('--priority', '-p',
              type=click.Choice(['low', 'medium', 'high']),
              help='按优先级过滤')
@click.option('--tag', '-t', help='按标签过滤')
@click.pass_context
def list(ctx, status: Optional[str], priority: Optional[str], 
         tag: Optional[str]):
    """列出任务"""
    tasks = ctx.obj['storage'].get_tasks()
    
    # 应用过滤器
    if status:
        tasks = [t for t in tasks if t.status.value == status]
    if priority:
        tasks = [t for t in tasks if t.priority.value == priority]
    if tag:
        tasks = [t for t in tasks if tag in t.tags]
    
    if not tasks:
        click.echo("📝 没有找到任务")
        return
    
    for task in tasks:
        status_icon = {"todo": "⏳", "doing": "🔄", "done": "✅"}
        priority_icon = {"low": "🔵", "medium": "🟡", "high": "🔴"}
        
        click.echo(f"{status_icon[task.status.value]} "
                  f"{priority_icon[task.priority.value]} "
                  f"[{task.id}] {task.title}")
        
        if task.description:
            click.echo(f"    📄 {task.description}")
        
        if task.tags:
            click.echo(f"    🏷️  {', '.join(task.tags)}")

if __name__ == "__main__":
    main()
```

## 🧪 构建前测试

### 创建构建测试脚本
```bash
#!/bin/bash
# scripts/build_test.sh - 构建前测试脚本

set -e

echo "🔍 开始构建前测试..."

# 1. 代码质量检查
echo "📝 代码格式检查..."
black --check src/ tests/

echo "📝 导入排序检查..."
isort --check-only src/ tests/

echo "📝 代码质量检查..."
flake8 src/ tests/

echo "📝 类型检查..."
mypy src/

# 2. 运行测试
echo "🧪 运行测试套件..."
pytest tests/ --cov=src/ --cov-report=term-missing

# 3. 检查包清单
echo "📋 检查包清单..."
check-manifest

# 4. 构建包
echo "🏗️ 构建包..."
python -m build

# 5. 检查构建产物
echo "🔍 检查构建产物..."
twine check dist/*

echo "✅ 所有检查通过！"
```

### 运行构建测试
```bash
# 给脚本执行权限
chmod +x scripts/build_test.sh

# 运行测试
./scripts/build_test.sh
```

## 📦 实际构建过程

### 1. 清理旧构建
```bash
# 清理旧的构建文件
rm -rf build/ dist/ *.egg-info/
```

### 2. 构建包
```bash
# 使用build工具构建
python -m build

# 查看构建结果
ls -la dist/
# taskmaster-1.0.0-py3-none-any.whl
# taskmaster-1.0.0.tar.gz
```

### 3. 检查构建产物
```bash
# 检查wheel内容
python -m zipfile -l dist/taskmaster-1.0.0-py3-none-any.whl

# 检查包元数据
twine check dist/*
```

## 🧪 本地安装测试

### 创建测试环境
```bash
# 创建新的虚拟环境进行测试
python -m venv test_env
source test_env/bin/activate  # Linux/Mac
# 或 test_env\Scripts\activate  # Windows

# 从wheel安装
pip install dist/taskmaster-1.0.0-py3-none-any.whl

# 测试命令行工具
taskmaster --version
taskmaster --help

# 测试基本功能
taskmaster add "测试任务" --description "这是一个测试任务"
taskmaster list

# 测试Python导入
python -c "import taskmaster; print(taskmaster.__version__)"

# 清理测试环境
deactivate
rm -rf test_env
```

### 功能测试脚本
```python
#!/usr/bin/env python3
# scripts/test_installation.py - 安装测试脚本

import subprocess
import sys
import tempfile
import os

def run_command(cmd, description):
    """运行命令并检查结果"""
    print(f"🔍 {description}...")
    try:
        result = subprocess.run(cmd, shell=True, check=True, 
                              capture_output=True, text=True)
        print(f"✅ {description} - 成功")
        return True
    except subprocess.CalledProcessError as e:
        print(f"❌ {description} - 失败")
        print(f"错误: {e.stderr}")
        return False

def main():
    """测试安装的包"""
    with tempfile.TemporaryDirectory() as temp_dir:
        os.chdir(temp_dir)
        
        tests = [
            ("taskmaster --version", "版本检查"),
            ("taskmaster --help", "帮助信息"),
            ("taskmaster add '测试任务' -d '测试描述'", "添加任务"),
            ("taskmaster list", "列出任务"),
            ("python -c 'import taskmaster; print(taskmaster.__version__)'", "Python导入"),
        ]
        
        failed_tests = []
        
        for cmd, desc in tests:
            if not run_command(cmd, desc):
                failed_tests.append(desc)
        
        if failed_tests:
            print(f"\n❌ {len(failed_tests)} 项测试失败:")
            for test in failed_tests:
                print(f"  - {test}")
            sys.exit(1)
        else:
            print(f"\n✅ 所有测试通过！")

if __name__ == "__main__":
    main()
```

## 🎯 本节小结

通过本节的学习，我们完成了：

### ✅ 完成的工作
- **项目结构标准化**：按照Python包标准组织项目结构
- **配置文件完善**：创建完整的pyproject.toml配置
- **命令行工具配置**：设置CLI入口点和命令
- **构建测试**：验证包的构建和安装
- **质量检查**：确保代码质量和包完整性

### 📦 构建产物
- **源码包**：taskmaster-1.0.0.tar.gz
- **二进制包**：taskmaster-1.0.0-py3-none-any.whl
- **命令行工具**：可以通过taskmaster命令使用
- **Python包**：可以通过import taskmaster导入

### 🔧 关键配置
- **入口点**：配置了taskmaster和tm两个命令
- **依赖管理**：明确声明了运行时和开发时依赖
- **类型支持**：包含py.typed文件支持类型检查
- **元数据完整**：提供了完整的包元数据信息

## 💡 关键要点

1. **结构标准**：遵循Python包的标准目录结构
2. **配置完整**：pyproject.toml包含所有必要配置
3. **测试验证**：构建前后都要进行充分测试
4. **命令行工具**：正确配置CLI入口点
5. **质量保证**：使用工具确保代码和包质量

## 📚 延伸学习
- 学习更多setuptools配置选项
- 了解不同构建后端的特点
- 研究复杂项目的打包策略
- 学习C扩展的打包方法

---
**下一节预告**：07-发布流程 - 学习如何将我们的TaskMaster包发布到PyPI
