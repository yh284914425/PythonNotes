# 07-发布流程

## 🚀 发布准备

在上一节中，我们已经成功构建了TaskMaster包。现在是时候将它发布到PyPI，让全世界的Python开发者都能使用我们的工具了！

### 发布前检查清单
```python
pre_release_checklist = {
    "代码质量": [
        "✅ 所有测试通过",
        "✅ 代码覆盖率 > 80%", 
        "✅ 代码格式化检查通过",
        "✅ 类型检查通过",
        "✅ 代码质量检查通过"
    ],
    "文档完整": [
        "✅ README.md完整且准确",
        "✅ CHANGELOG.md更新",
        "✅ API文档生成",
        "✅ 使用示例测试通过"
    ],
    "包配置": [
        "✅ pyproject.toml配置正确",
        "✅ 版本号更新",
        "✅ 依赖关系验证",
        "✅ 分类器准确"
    ],
    "构建验证": [
        "✅ 本地构建成功",
        "✅ 包内容检查通过",
        "✅ 安装测试成功",
        "✅ 功能测试通过"
    ]
}
```

## 🔐 账户和认证设置

### 1. 注册PyPI账户
```bash
# 1. 访问 https://pypi.org/account/register/
# 2. 填写用户名、邮箱、密码
# 3. 验证邮箱地址
# 4. 启用双因素认证（强烈推荐）

# 同时注册TestPyPI账户用于测试
# 访问 https://test.pypi.org/account/register/
```

### 2. 创建API Token
```bash
# 在PyPI账户设置中创建API Token
# 1. 登录PyPI -> Account settings -> API tokens
# 2. 点击"Add API token"
# 3. 选择作用域（建议选择特定项目）
# 4. 复制生成的token（只显示一次）
```

### 3. 配置本地认证
```bash
# 方法1：创建.pypirc文件
cat > ~/.pypirc << 'EOF'
[distutils]
index-servers =
    pypi
    testpypi

[pypi]
username = __token__
password = pypi-your-api-token-here

[testpypi]
repository = https://test.pypi.org/legacy/
username = __token__
password = pypi-your-test-api-token-here
EOF

# 设置文件权限
chmod 600 ~/.pypirc

# 方法2：使用环境变量
export TWINE_USERNAME=__token__
export TWINE_PASSWORD=pypi-your-api-token-here
```

## 🧪 TestPyPI测试发布

### 为什么先发布到TestPyPI？
```python
testpypi_benefits = {
    "安全测试": "在测试环境验证发布流程",
    "错误发现": "发现配置问题而不影响正式环境",
    "流程熟悉": "熟悉发布流程和工具使用",
    "版本测试": "测试版本号和元数据",
    "依赖验证": "验证依赖关系是否正确"
}
```

### 发布到TestPyPI
```bash
# 1. 安装twine（如果还没安装）
pip install twine

# 2. 检查构建产物
twine check dist/*

# 3. 发布到TestPyPI
twine upload --repository testpypi dist/*

# 4. 查看发布结果
# 访问 https://test.pypi.org/project/taskmaster/
```

### 从TestPyPI安装测试
```bash
# 创建新的测试环境
python -m venv test_testpypi
source test_testpypi/bin/activate

# 从TestPyPI安装
pip install --index-url https://test.pypi.org/simple/ \
    --extra-index-url https://pypi.org/simple/ \
    taskmaster

# 测试功能
taskmaster --version
taskmaster add "测试任务" --description "从TestPyPI安装的测试"
taskmaster list

# 清理
deactivate
rm -rf test_testpypi
```

## 📝 发布前最终检查

### 自动化检查脚本
```python
#!/usr/bin/env python3
# scripts/pre_release_check.py - 发布前检查脚本

import subprocess
import sys
import json
from pathlib import Path

def run_command(cmd, description, capture_output=True):
    """运行命令并检查结果"""
    print(f"🔍 {description}...")
    try:
        result = subprocess.run(
            cmd, shell=True, check=True, 
            capture_output=capture_output, text=True
        )
        print(f"✅ {description} - 通过")
        return True, result.stdout if capture_output else ""
    except subprocess.CalledProcessError as e:
        print(f"❌ {description} - 失败")
        if capture_output:
            print(f"错误: {e.stderr}")
        return False, ""

def check_version_consistency():
    """检查版本号一致性"""
    print("🔍 检查版本号一致性...")
    
    # 从pyproject.toml读取版本
    import tomli
    with open("pyproject.toml", "rb") as f:
        pyproject = tomli.load(f)
    pyproject_version = pyproject["project"]["version"]
    
    # 从__init__.py读取版本
    init_file = Path("src/taskmaster/__init__.py")
    init_content = init_file.read_text()
    for line in init_content.split('\n'):
        if line.startswith('__version__'):
            init_version = line.split('=')[1].strip().strip('"\'')
            break
    else:
        print("❌ 在__init__.py中找不到版本号")
        return False
    
    if pyproject_version == init_version:
        print(f"✅ 版本号一致: {pyproject_version}")
        return True
    else:
        print(f"❌ 版本号不一致: pyproject.toml={pyproject_version}, __init__.py={init_version}")
        return False

def main():
    """执行发布前检查"""
    checks = [
        # 代码质量检查
        ("black --check src/ tests/", "代码格式检查"),
        ("isort --check-only src/ tests/", "导入排序检查"),
        ("flake8 src/ tests/", "代码质量检查"),
        ("mypy src/", "类型检查"),
        
        # 测试检查
        ("pytest tests/ --cov=src/ --cov-report=term", "测试和覆盖率"),
        
        # 包检查
        ("check-manifest", "包清单检查"),
        ("python -m build", "包构建"),
        ("twine check dist/*", "构建产物检查"),
    ]
    
    failed_checks = []
    
    # 版本一致性检查
    if not check_version_consistency():
        failed_checks.append("版本号一致性检查")
    
    # 运行其他检查
    for cmd, desc in checks:
        success, _ = run_command(cmd, desc)
        if not success:
            failed_checks.append(desc)
    
    # 检查结果
    if failed_checks:
        print(f"\n❌ {len(failed_checks)} 项检查失败:")
        for check in failed_checks:
            print(f"  - {check}")
        print("\n请修复上述问题后再次运行检查。")
        sys.exit(1)
    else:
        print(f"\n✅ 所有检查通过！可以发布到PyPI。")
        print("\n下一步:")
        print("1. 确认版本号和更新日志")
        print("2. 创建Git标签: git tag v1.0.0")
        print("3. 发布到PyPI: twine upload dist/*")

if __name__ == "__main__":
    main()
```

### 运行最终检查
```bash
# 安装检查依赖
pip install tomli check-manifest

# 运行检查脚本
python scripts/pre_release_check.py
```

## 🏷️ 版本标签和Git管理

### 创建发布标签
```bash
# 1. 确保所有更改都已提交
git status
git add .
git commit -m "Prepare for v1.0.0 release"

# 2. 创建带注释的标签
git tag -a v1.0.0 -m "Release version 1.0.0

Features:
- Complete task management functionality
- Command-line interface with rich output
- JSON-based data storage
- Comprehensive test coverage
- Full documentation

This is the first stable release of TaskMaster."

# 3. 推送标签到远程仓库
git push origin main
git push origin v1.0.0
```

### 更新CHANGELOG.md
```markdown
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [1.0.0] - 2024-01-15

### Added
- Complete task management functionality
- Command-line interface with `taskmaster` and `tm` commands
- Task CRUD operations (Create, Read, Update, Delete)
- Task status management (todo, doing, done)
- Priority levels (low, medium, high)
- Task tagging and filtering
- Rich console output with colors and icons
- JSON-based data storage
- Comprehensive test suite with >90% coverage
- Complete documentation with examples
- Type hints support

### Technical
- Python 3.8+ support
- Click-based CLI framework
- Pydantic data validation
- pytest testing framework
- Black code formatting
- mypy type checking
- Sphinx documentation

## [Unreleased]
- Initial development
```

## 🚀 正式发布到PyPI

### 发布命令
```bash
# 1. 最后一次检查
twine check dist/*

# 2. 发布到PyPI
twine upload dist/*

# 3. 查看发布结果
# 访问 https://pypi.org/project/taskmaster/
```

### 发布后验证
```bash
# 等待几分钟让PyPI索引更新，然后测试安装
python -m venv test_pypi_install
source test_pypi_install/bin/activate

# 从PyPI安装
pip install taskmaster

# 测试功能
taskmaster --version
taskmaster add "第一个真实任务" --description "从PyPI安装成功！"
taskmaster list

# 测试Python导入
python -c "import taskmaster; print(f'TaskMaster v{taskmaster.__version__} 安装成功！')"

# 清理
deactivate
rm -rf test_pypi_install
```

## 📢 发布公告

### GitHub Release
```markdown
# TaskMaster v1.0.0 🎉

我们很高兴地宣布TaskMaster的第一个稳定版本发布！

## 🌟 主要特性

- **完整的任务管理功能**：创建、查看、更新、删除任务
- **直观的命令行界面**：使用`taskmaster`或`tm`命令
- **任务状态管理**：待办、进行中、已完成
- **优先级设置**：低、中、高三个优先级
- **标签和过滤**：为任务添加标签并按条件过滤
- **美观的输出**：彩色图标和格式化输出
- **类型安全**：完整的类型提示支持

## 📦 安装

```bash
pip install taskmaster
```

## 🚀 快速开始

```bash
# 添加任务
taskmaster add "学习Python" --description "完成Python教程" --priority high

# 查看任务
taskmaster list

# 按状态过滤
taskmaster list --status todo
```

## 📚 文档

- [完整文档](https://taskmaster.readthedocs.io/)
- [GitHub仓库](https://github.com/yourusername/taskmaster)
- [PyPI页面](https://pypi.org/project/taskmaster/)

## 🙏 致谢

感谢所有测试用户的反馈和建议！

---

**安装命令**: `pip install taskmaster`
**源码**: https://github.com/yourusername/taskmaster
**文档**: https://taskmaster.readthedocs.io/
```

### 社交媒体分享
```python
social_media_posts = {
    "Twitter": """
🎉 TaskMaster v1.0.0 发布了！

一个简单而强大的Python命令行任务管理工具：
✅ 任务增删改查
🏷️ 标签和过滤
🎨 美观的CLI界面
📦 pip install taskmaster

#Python #CLI #Productivity #OpenSource
https://pypi.org/project/taskmaster/
    """,
    
    "LinkedIn": """
很高兴分享我的最新开源项目：TaskMaster v1.0.0！

这是一个用Python开发的命令行任务管理工具，具有：
• 完整的任务管理功能
• 直观的命令行界面
• 类型安全和测试覆盖
• 详细的文档

项目从需求分析到发布的完整过程都遵循了Python开发的最佳实践。

安装：pip install taskmaster
源码：https://github.com/yourusername/taskmaster

#Python #SoftwareDevelopment #OpenSource #CLI
    """
}
```

## 📊 发布后监控

### 监控指标
```python
monitoring_metrics = {
    "下载统计": "PyPI下载量和趋势",
    "用户反馈": "GitHub issues和discussions",
    "代码质量": "测试覆盖率和代码质量指标",
    "文档访问": "文档站点访问量",
    "社区参与": "Star、Fork、贡献者数量"
}
```

### 设置监控
```bash
# 1. 启用PyPI下载统计
# PyPI会自动提供下载统计

# 2. 设置GitHub通知
# 在GitHub仓库设置中启用issue和PR通知

# 3. 监控工具
pip install pypistats
pypistats recent taskmaster
```

## 🎯 本节小结

通过本节的学习，我们完成了：

### ✅ 发布成就
- **TestPyPI测试**：在测试环境验证发布流程
- **质量检查**：通过全面的发布前检查
- **版本管理**：创建Git标签和更新日志
- **正式发布**：成功发布到PyPI
- **发布验证**：确认包可以正常安装使用

### 🌟 项目里程碑
- **公开可用**：全世界的Python开发者都可以使用
- **专业品质**：遵循所有最佳实践和标准
- **完整文档**：提供详细的使用和开发文档
- **社区就绪**：准备好接受社区贡献和反馈

### 📈 后续计划
- **用户反馈**：收集和响应用户反馈
- **功能改进**：基于使用情况改进功能
- **版本迭代**：定期发布更新版本
- **社区建设**：建立活跃的用户和贡献者社区

## 💡 关键要点

1. **测试先行**：先在TestPyPI测试，再发布到正式PyPI
2. **质量保证**：发布前进行全面的自动化检查
3. **版本管理**：使用Git标签管理发布版本
4. **文档完整**：提供清晰的安装和使用说明
5. **社区沟通**：主动分享和推广项目

## 🎉 恭喜！

恭喜你成功完成了从项目开发到发布的完整流程！TaskMaster现在是一个真正的开源Python包，可以被全世界的开发者使用。

---
**下一节预告**：08-项目维护 - 学习如何维护和改进已发布的项目
